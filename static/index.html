<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
        <meta name="format-detection" content="telephone=no">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="renderer" content="webkit">
        <meta name="robots" content="index, follow">

        <title>hallelujah input method on web</title>
        <link rel="stylesheet" type="text/css" href="/awesomplete.css" />
        <style>
            main {
                max-width: 70vw;
                margin: 10px auto auto auto;
            }

            #webim {
                width: 70vw;
                vertical-align: top;
                padding: 5px;
            }
        </style>
    </head>
    <body>
        <main>
            <a href="https://github.com/dongyuwei/hallelujahIM" target="_blank">Mac OSX版hallelujah英文输入法</a>
            <textarea id="webim" cols="30" rows="3" placeholder="please input any english words..."></textarea>
        </main>

        <script src='/awesomplete.js'></script>
        <script src="/jquery-2.2.1.min.js"></script>

        <script>
            void function(){
                if ("WebSocket" in window) {
                    var ws = new WebSocket("ws://" + location.hostname + ":3001");
                    
                    var awesomplete, oInput = $('#webim');
                    var MinChars = 3;
                    ws.onopen = function() {
                        console.log("websocket connected!");
                        
                        awesomplete = new Awesomplete(oInput[0], {
                            minChars: MinChars, 
                            autoFirst: true,
                            filter: function (item, input) {
                                var arr = input.trim().split(' ');
                                var lastWord = arr[arr.length - 1];
                                return item.value.indexOf(lastWord) === 0;
                            },
                            replace: function (text) {
                                var arr = this.input.value.trim().split(' ');
                                arr.pop();
                                arr.push(text);
                                this.input.value = arr.join(' ') + ' ';
                            },
                            sort: false
                        });   

                        oInput.on('input', function(){
                            var arr = this.value.trim().split(' ');
                            var lastWord = arr[arr.length - 1];
                            if (lastWord.length >= MinChars) {
                                ws.send(lastWord);
                            } else {
                                awesomplete.list = [];
                            }
                        });
                    };
                    ws.onmessage = function (evt) {
                        awesomplete.list = JSON.parse(evt.data);
                    };
                    ws.onclose = function() {
                        console.log("websocket closed");
                    };
                }
            }();
        </script>
    </body>
</html>